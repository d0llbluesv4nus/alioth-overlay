name: Build Alioth Overlay

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aapt apksigner

      - name: Generate XML Files (Fixed Duplicates)
        run: |
          mkdir -p res/values

          # --- CONFIG.XML ---
          # Убрали rounded_corner_radius отсюда, так как он есть в dimens.xml
          cat <<EOF > res/values/config.xml
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <bool name="config_showNavigationBar">true</bool>
              <!-- Вырез камеры -->
              <string name="config_mainBuiltInDisplayCutout">M 540,35 a 35,35 0 1,0 0,70 a 35,35 0 1,0 0,-70 Z</string>
              <bool name="config_fillMainBuiltInDisplayCutout">true</bool>
              <!-- Яркость -->
              <bool name="config_automatic_brightness_available">true</bool>
              <integer name="config_screenBrightnessSettingMinimum">1</integer>
              <integer name="config_screenBrightnessSettingMaximum">1023</integer>
              <integer name="config_screenBrightnessDoze">17</integer>
              <!-- Герцовка -->
              <integer name="config_defaultRefreshRate">120</integer>
              <integer name="config_defaultPeakRefreshRate">120</integer>
              <!-- Сканер -->
              <bool name="config_fingerprintSupportsGestures">true</bool>
          </resources>
          EOF

          # --- DIMENS.XML ---
          # Оставляем размеры и скругления здесь
          cat <<EOF > res/values/dimens.xml
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <dimen name="status_bar_height">38dp</dimen>
              <dimen name="status_bar_height_portrait">38dp</dimen>
              <dimen name="status_bar_height_landscape">24dp</dimen>
              
              <dimen name="rounded_corner_radius">110px</dimen>
              <dimen name="rounded_corner_radius_top">110px</dimen>
              <dimen name="rounded_corner_radius_bottom">110px</dimen>
          </resources>
          EOF

      - name: Compile Overlay APK
        run: |
          ANDROID_JAR="$ANDROID_SDK_ROOT/platforms/android-34/android.jar"
          if [ ! -f "$ANDROID_JAR" ]; then
            ANDROID_JAR="$ANDROID_SDK_ROOT/platforms/android-33/android.jar"
          fi
          
          echo "Using android.jar at: $ANDROID_JAR"

          aapt package -f \
            -M AndroidManifest.xml \
            -S res \
            -I "$ANDROID_JAR" \
            -F unaligned.apk \
            --min-sdk-version 29 \
            --target-sdk-version 30
            
      - name: Sign APK
        run: |
          keytool -genkey -v -keystore test.keystore -alias test -keyalg RSA -keysize 2048 -validity 10000 -storepass password -keypass password -dname "CN=Android Debug,O=Android,C=US"
          apksigner sign --ks test.keystore --ks-pass pass:password --out treble_overlay_xiaomi_alioth.apk unaligned.apk

      - name: Upload Overlay APK
        uses: actions/upload-artifact@v4
        with:
          name: treble_overlay_xiaomi_alioth
          path: treble_overlay_xiaomi_alioth.apk
